{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>{% block title %}AI Finance Tracker{% endblock %}</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<!-- PWA -->
<link rel="manifest" href="{% static 'manifest.json' %}">
<meta name="theme-color" content="#0d6efd">

<style>
/* ================= GLOBAL ================= */
body{
  background:linear-gradient(135deg,#f8f9fa,#eef2f7);
  transition:.3s;
}
body.dark{background:#121212;color:#eaeaea}
body.dark .card{background:#1e1e1e;color:#eaeaea}
body.dark .navbar{background:#000!important}

/* ================= NAVBAR ================= */
.navbar .nav-link{
  position:relative;
  padding:.5rem .75rem;
}
.navbar .nav-link::after{
  content:"";
  position:absolute;
  bottom:-6px;
  left:50%;
  width:0;height:3px;
  background:linear-gradient(90deg,#0d6efd,#6ea8fe);
  transform:translateX(-50%);
  transition:.3s;
}
.navbar .nav-link.active::after,
.navbar .nav-link:hover::after{width:80%}
.navbar .nav-link.active{
  color:#fff!important;
  font-weight:600;
  text-shadow:0 0 8px rgba(13,110,253,.6);
}

/* ================= MOBILE NAV ================= */
.mobile-nav{
  position:fixed;bottom:0;left:0;right:0;
  height:64px;background:#111;
  display:flex;z-index:1050;
}
.mobile-nav a{
  flex:1;text-align:center;
  color:#aaa;text-decoration:none;
  font-size:12px;padding-top:8px;
}
.mobile-nav a.active{color:#0d6efd}
.mobile-nav i{font-size:20px;display:block}
@media(max-width:991px){body{padding-bottom:70px}}

/* ================= CHATBOT ================= */
#chatbotBtn{
  position:fixed;right:20px;bottom:90px;
  width:56px;height:56px;border-radius:50%;
  background:#0d6efd;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:26px;cursor:pointer;
  box-shadow:0 8px 20px rgba(0,0,0,.25);
  z-index:1100;
}
#chatbotBox{
  position:fixed;right:20px;bottom:160px;
  width:320px;max-height:420px;
  background:#fff;border-radius:14px;
  display:none;flex-direction:column;
  overflow:hidden;z-index:1100;
}
body.dark #chatbotBox{background:#1e1e1e}
.chat-header{
  background:#0d6efd;color:#fff;
  padding:10px;font-weight:600;
  display:flex;justify-content:space-between;
}
#chatMessages{
  flex:1;padding:10px;overflow-y:auto;font-size:14px;
}
.chat-user{text-align:right;margin-bottom:6px}
.chat-bot{text-align:left;margin-bottom:6px;opacity:.9}
#chatForm{display:flex;border-top:1px solid #ddd}
#chatForm input{
  flex:1;border:none;padding:10px;outline:none;
}
#chatForm button{
  border:none;background:#0d6efd;
  color:#fff;padding:0 14px;
}
</style>
</head>

<body>

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
<div class="container">
<a class="navbar-brand fw-bold" href="{% url 'dashboard' %}">AI Finance Tracker</a>

<button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#mainNav">
<span class="navbar-toggler-icon"></span>
</button>

<div class="collapse navbar-collapse" id="mainNav">
<ul class="navbar-nav ms-auto align-items-center">

{% if user.is_authenticated %}
<li class="nav-item">
<a class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}" href="{% url 'dashboard' %}">
<i class="bi bi-speedometer2"></i> Dashboard
</a>
</li>

<li class="nav-item">
<a class="nav-link {% if request.resolver_match.url_name == 'all_transactions' %}active{% endif %}" href="{% url 'all_transactions' %}">
<i class="bi bi-receipt"></i> Transactions
</a>
</li>

<li class="nav-item">
<a class="nav-link {% if request.resolver_match.url_name == 'budgets_list' %}active{% endif %}" href="{% url 'budgets_list' %}">
<i class="bi bi-pie-chart"></i> Budgets
</a>
</li>

{% if user.is_staff %}
<li class="nav-item">
<a class="nav-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}" href="{% url 'admin_dashboard' %}">
<i class="bi bi-shield-lock"></i> Admin
</a>
</li>
{% endif %}

<li class="nav-item ms-2">
<button id="installBtn" class="btn btn-outline-primary btn-sm d-none">
<i class="bi bi-download"></i> Install
</button>
</li>

<li class="nav-item">
<form method="post" action="{% url 'logout' %}">
{% csrf_token %}
<button class="btn btn-link nav-link">Logout</button>
</form>
</li>
{% endif %}

<li class="nav-item ms-2">
<button id="themeToggle" class="btn btn-outline-light btn-sm">ðŸŒ™</button>
</li>
</ul>
</div>
</div>
</nav>

<!-- ================= CONTENT ================= -->
<div class="container my-5">
{% block content %}{% endblock %}
</div>

<!-- ================= MOBILE NAV ================= -->
<nav class="mobile-nav d-lg-none">
<a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
<i class="bi bi-speedometer2"></i>Home</a>
<a href="{% url 'all_transactions' %}" class="{% if request.resolver_match.url_name == 'all_transactions' %}active{% endif %}">
<i class="bi bi-receipt"></i>Txns</a>
<a href="{% url 'budgets_list' %}" class="{% if request.resolver_match.url_name == 'budgets_list' %}active{% endif %}">
<i class="bi bi-pie-chart"></i>Budget</a>
<a href="#" id="installBtnMobile"><i class="bi bi-download"></i>Install</a>
</nav>

<!-- ================= CHATBOT ================= -->
<div id="chatbotBtn">ðŸ’¬</div>

<div id="chatbotBox">
<div class="chat-header">
ðŸ¤– Finance Assistant
<span id="chatClose">âœ–</span>
</div>

<div id="chatMessages"></div>

<form id="chatForm">
<input id="chatInput" placeholder="Ask about budgets, expensesâ€¦" autocomplete="off">
<button>âž¤</button>
</form>
</div>

<!-- ================= JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
const t=document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="dark")document.body.classList.add("dark");
t.onclick=()=>{document.body.classList.toggle("dark");
localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");};
});
</script>

<script>
let deferredPrompt=null;
const iBtn=document.getElementById("installBtn");
const iBtnM=document.getElementById("installBtnMobile");
window.addEventListener("beforeinstallprompt",e=>{
e.preventDefault();deferredPrompt=e;iBtn.classList.remove("d-none");
});
function install(){if(!deferredPrompt)return;
deferredPrompt.prompt();deferredPrompt=null;iBtn.classList.add("d-none");}
iBtn.onclick=install;iBtnM.onclick=e=>{e.preventDefault();install();}
</script>

<script>
const cb=document.getElementById("chatbotBtn"),
bx=document.getElementById("chatbotBox"),
cl=document.getElementById("chatClose"),
fm=document.getElementById("chatForm"),
ip=document.getElementById("chatInput"),
ms=document.getElementById("chatMessages");

cb.onclick=()=>bx.style.display="flex";
cl.onclick=()=>bx.style.display="none";

fm.onsubmit=e=>{
e.preventDefault();
const m=ip.value.trim(); if(!m)return;
ms.innerHTML+=`<div class="chat-user">ðŸ§‘ ${m}</div>`;
ip.value="";
fetch("{% url 'chat_api' %}",{
method:"POST",
headers:{
"Content-Type":"application/json",
"X-CSRFToken":"{{ csrf_token }}"
},
body:JSON.stringify({message:m})
})
.then(r=>r.json())
.then(d=>{
ms.innerHTML+=`<div class="chat-bot">ðŸ¤– ${d.reply}</div>`;
ms.scrollTop=ms.scrollHeight;
});
};
</script>

<script>
if("serviceWorker"in navigator){
navigator.serviceWorker.register("{% static 'service-worker.js' %}");
}
</script>

</body>
</html>
