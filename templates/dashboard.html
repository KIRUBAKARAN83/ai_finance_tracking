{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<style>
/* ================= THEME (Premium Teal + Royal Indigo) ================= */
:root{
  /* Primary palette */
  --income-start: #00B894;   /* Premium Teal */
  --income-end:   #00D2FF;   /* Cyan highlight */

  --savings-start:#6F4FF2;   /* Royal Indigo */
  --savings-end:  #A78BFA;   /* Lavender */

  /* Accent / alerts */
  --expense-start:#FF6B6B;   /* Coral (danger) */
  --expense-end:  #FF8A65;
  --gold-1:       #FFD166;   /* Gold accent */

  /* UI tokens */
  --bg:           #F7FBFC;
  --card-glass:   rgba(255,255,255,.65);
  --muted:        rgba(15,23,36,.6);
  --card-border:  rgba(255,255,255,.22);
  --text-strong:  #0F1724;
}

/* ================= REVEAL ================= */
.reveal{
  opacity:0;
  transform:translateY(40px) scale(.98) rotate(-0.6deg);
  transition:all .9s cubic-bezier(.22,.61,.36,1);
  will-change:transform,opacity;
}
.reveal.active{
  opacity:1;
  transform:translateY(0) scale(1) rotate(0deg);
  transition:all 1s cubic-bezier(.19,1,.22,1);
}

/* ================= CARDS ================= */
.card{
  position:relative;
  border:none;
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.56), rgba(255,255,255,.44));
  backdrop-filter:blur(18px) saturate(140%);
  -webkit-backdrop-filter:blur(18px) saturate(140%);
  box-shadow:0 18px 45px rgba(0,0,0,.12);
  transition:transform .45s cubic-bezier(.2,.9,.2,1), box-shadow .45s cubic-bezier(.2,.9,.2,1), border .45s ease;
  border:1px solid var(--card-border);
  overflow:hidden;
}
.card::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  border-radius:inherit;
  mix-blend-mode:overlay;
  opacity:.06;
}
.card:hover{
  transform:translateY(-12px) scale(1.02);
  box-shadow:0 35px 75px rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.38);
}
.card .card-body{position:relative;z-index:2}

/* ================= SUMMARY ================= */
.summary-card{
  color:#fff;
  position:relative;
  overflow:hidden;
}
.summary-card::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg, rgba(255,255,255,.03), rgba(0,0,0,.03));
  mix-blend-mode:overlay;
  z-index:1;
}
.summary-card .card-body{position:relative;z-index:2}
.income{background:linear-gradient(135deg,var(--income-start),var(--income-end))}
.expense{background:linear-gradient(135deg,var(--expense-start),var(--expense-end))}
.savings{background:linear-gradient(135deg,var(--savings-start),var(--savings-end))}

.summary-card h6{opacity:.95;font-weight:700;letter-spacing:.2px}
.summary-card h3{font-weight:800;letter-spacing:.6px}

/* accent glow */
.summary-card:hover{box-shadow:0 30px 80px rgba(0,0,0,.22), 0 0 30px rgba(0,0,0,.06) inset}

/* ================= PROGRESS ================= */
.progress{
  background:rgba(255,255,255,.12);
  border-radius:20px;
  height:10px;
  overflow:hidden;
  position:relative;
}
.progress-bar{
  width:0%;
  height:100%;
  border-radius:20px;
  transition:width 1.6s cubic-bezier(.22,.61,.36,1);
  background-size:200% 100%;
  box-shadow:0 6px 18px rgba(0,0,0,.08) inset;
}

/* shimmer for progress */
.progress-bar.shimmer{
  animation:shimmer 2.2s linear infinite;
  background-image: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
}
@keyframes shimmer{
  0%{background-position:0% 50%}
  100%{background-position:100% 50%}
}

/* ================= BUTTONS ================= */
.btn{
  transition:transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s ease, background .28s ease;
  border-radius:12px;
  font-weight:600;
}
.btn:active{transform:translateY(1px) scale(.997)}
.btn-success{
  background:linear-gradient(135deg,var(--income-start),var(--income-end));
  border:none;color:#fff;
  box-shadow:0 10px 30px rgba(0,210,255,.12);
}
.btn-success:hover{
  transform:translateY(-3px);
  box-shadow:0 18px 45px rgba(0,210,255,.18);
}
.btn-outline-dark{
  border-radius:12px;
  border:1px solid rgba(0,0,0,.08);
  background:transparent;
  color:var(--muted);
}
.btn-outline-dark:hover{
  background:rgba(0,0,0,.04);
  transform:translateY(-2px);
}
.btn-outline-primary{
  border-radius:12px;
  border:1px solid rgba(123,97,255,.12);
  color:var(--savings-end);
  background:transparent;
}
.btn-outline-primary:hover{
  background:linear-gradient(90deg, rgba(123,97,255,.06), rgba(167,139,250,.06));
  transform:translateY(-2px);
}

/* ================= CHAT ================= */
#chatBox{
  background:linear-gradient(180deg,#fbfdff,#f3f7fb);
  padding:14px;border-radius:14px;
  box-shadow:0 8px 30px rgba(0,0,0,.06) inset;
}
.chat-user{
  background:linear-gradient(135deg,var(--income-start),var(--income-end));
  color:#fff;
  padding:10px 16px;
  border-radius:18px 18px 0 18px;
  margin:8px 0;
  max-width:72%;
  margin-left:auto;
  animation:pop .28s cubic-bezier(.2,.9,.2,1);
  box-shadow:0 8px 20px rgba(0,210,255,.08);
}
.chat-bot{
  background:linear-gradient(135deg,#ffffff,#eef3f8);
  padding:10px 16px;
  border-radius:18px 18px 18px 0;
  margin:8px 0;
  max-width:72%;
  animation:pop .28s cubic-bezier(.2,.9,.2,1);
  color:var(--muted);
  border:1px solid rgba(0,0,0,.03);
}
@keyframes pop{
  from{opacity:0;transform:scale(.95) translateY(6px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}
.chat-bot.typing{font-style:italic;opacity:.85}

/* ================= TEXT & LIST ANIMATIONS ================= */
h3.fw-bold.reveal{
  transform-origin:left center;
  transition:all .9s cubic-bezier(.22,.61,.36,1);
}
ul.mb-0 li{
  opacity:0;
  transform:translateX(-18px);
  animation:fadeSlide .6s forwards;
}
ul.mb-0 li:nth-child(1){animation-delay:.18s}
ul.mb-0 li:nth-child(2){animation-delay:.34s}
ul.mb-0 li:nth-child(3){animation-delay:.5s}
@keyframes fadeSlide{ to{opacity:1;transform:translateX(0)} }

/* ================= CHART CANVAS STYLING ================= */
canvas{display:block;max-width:100%}

/* ================= SMALL SCREENS ================= */
@media (max-width:576px){
  .summary-card h3{font-size:1.25rem}
  .card{border-radius:14px}
  .btn{font-size:.95rem}
}
/* ================= HEALTH METER ================= */
.health-meter{
  width:160px;
  height:160px;
  position:relative;
}

.health-meter svg{
  width:100%;
  height:100%;
  transform:rotate(-90deg);
}

.meter-bg{
  fill:none;
  stroke:rgba(0,0,0,.08);
  stroke-width:12;
}

body.dark .meter-bg{
  stroke:rgba(255,255,255,.12);
}

.meter-progress{
  fill:none;
  stroke-width:12;
  stroke-linecap:round;
  stroke-dasharray:327;
  stroke-dashoffset:327;
  transition:stroke-dashoffset 1.6s cubic-bezier(.22,.61,.36,1);
}

/* Dynamic colors */
.health-meter[data-color="success"] .meter-progress{ stroke:#2ecc71; }
.health-meter[data-color="primary"] .meter-progress{ stroke:#0d6efd; }
.health-meter[data-color="warning"] .meter-progress{ stroke:#f39c12; }
.health-meter[data-color="danger"]  .meter-progress{ stroke:#e74c3c; }

.meter-value{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  font-weight:800;
}

.meter-value span{
  font-size:42px;
  line-height:1;
}

.meter-value small{
  font-size:14px;
  opacity:.6;
}
/* ================= TREND ================= */
.trend{
  font-weight:700;
  padding:6px 14px;
  border-radius:999px;
  font-size:14px;
}
.trend.up{
  background:rgba(46,204,113,.15);
  color:#2ecc71;
}
.trend.down{
  background:rgba(231,76,60,.15);
  color:#e74c3c;
}
.trend.stable{
  background:rgba(149,165,166,.15);
  color:#95a5a6;
}

/* ================= BREAKDOWN ================= */
.health-breakdown .progress{
  height:8px;
  background:rgba(0,0,0,.08);
  border-radius:999px;
  overflow:hidden;
}

body.dark .health-breakdown .progress{
  background:rgba(255,255,255,.15);
}

.health-breakdown .progress-bar{
  width:0%;
  border-radius:999px;
  background:linear-gradient(90deg,#0d6efd,#6ea8fe);
  transition:width 1.4s cubic-bezier(.22,.61,.36,1);
}
.card .fs-1 {
  animation: pulse 1.2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.15); }
  100% { transform: scale(1); }
}



</style>

<h3 class="fw-bold mb-4 reveal">ðŸ“Š AI Finance Dashboard</h3>

<!-- =====================================================
  1ï¸âƒ£ SUMMARY CARDS
===================================================== -->
<div class="row g-4 mb-4">
  <div class="col-md-4 reveal">
    <div class="card summary-card income">
      <div class="card-body">
        <h6>ðŸ’° Income</h6>
        <h3 id="incomeCounter">â‚¹0</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4 reveal">
    <div class="card summary-card expense">
      <div class="card-body">
        <h6>ðŸ“‰ Expense</h6>
        <h3 id="expenseCounter">â‚¹0</h3>
      </div>
    </div>
  </div>

  <div class="col-md-4 reveal">
    <div class="card summary-card savings">
      <div class="card-body">
        <h6>ðŸ’Ž Savings</h6>
        <h3 id="savingsCounter">â‚¹0</h3>
      </div>
    </div>
  </div>
</div>

<!-- =====================================================
  2ï¸âƒ£ FINANCE HEALTH SCORE
===================================================== -->
<div class="card mb-4 reveal text-center">
  <div class="card-body">
    <h5 class="fw-bold mb-3">ðŸ’– Finance Health Score</h5>

    <div class="health-meter mx-auto"
         data-score="{{ health_score }}"
         data-color="{{ health_color }}">

      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="52" class="meter-bg"/>
        <circle cx="60" cy="60" r="52" class="meter-progress"/>
      </svg>

      <div class="meter-value">
        <span id="healthValue">0</span>
        <small>/100</small>
      </div>
    </div>

    <span class="badge bg-{{ health_color }} mt-3 px-3 py-2">
      {{ health_grade }}
    </span>

    <p class="text-muted mt-3 mb-0">
      Based on savings, expenses, budgets & income stability
    </p>
  </div>
</div>

<!-- =====================================================
  3ï¸âƒ£ MONTHLY COMPARISON
===================================================== -->
<div class="card mb-4 reveal">
  <div class="card-body">
    <h5 class="fw-bold mb-2">ðŸ“† Monthly Expense Comparison</h5>

    <div class="d-flex align-items-center gap-3">
      <div class="fs-1">
        {% if comparison.direction == "up" %} ðŸ”º
        {% elif comparison.direction == "down" %} ðŸ”»
        {% else %} âž– {% endif %}
      </div>

      <div>
        <p class="mb-1 fw-semibold text-{{ comparison.color }}">
          {{ comparison.message }}
        </p>

        {% if comparison.status != "no-data" %}
          <small class="text-muted">
            Change: {{ comparison.percent }}%
          </small>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- =====================================================
  4ï¸âƒ£ AI INSIGHTS
===================================================== -->
<div class="card mb-4 reveal">
  <div class="card-body">
    <h5 class="fw-bold mb-3">ðŸ¤– AI Insights</h5>

    {% if insights or auto_insights %}
      <ul class="mb-0">
        {% for i in insights %}<li>âœ” {{ i }}</li>{% endfor %}
        {% for ai in auto_insights %}<li>ðŸ§  {{ ai }}</li>{% endfor %}
      </ul>
    {% else %}
      <p class="text-muted mb-0">No insights yet.</p>
    {% endif %}
  </div>
</div>

<!-- =====================================================
  5ï¸âƒ£ BUDGETS
===================================================== -->
{% if budgets %}
<div class="card mb-4 reveal">
  <div class="card-body">
    <h5 class="fw-bold mb-3">ðŸ“‰ Budget Usage</h5>

    {% for b in budgets %}
    <div class="mb-3">
      <div class="d-flex justify-content-between fw-semibold">
        <span>{{ b.category }}</span>
        <span>â‚¹{{ b.spent }} / â‚¹{{ b.limit }}</span>
      </div>
      <div class="progress mt-1">
        <div class="progress-bar shimmer"
             data-percent="{{ b.percent }}">
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- =====================================================
  6ï¸âƒ£ CHARTS
===================================================== -->
<div class="row g-4 mb-5">
  <div class="col-md-6 reveal">
    <div class="card"><div class="card-body">
      <canvas id="barChart" style="height:320px"></canvas>
    </div></div>
  </div>
  <div class="col-md-6 reveal">
    <div class="card"><div class="card-body">
      <canvas id="pieChart" style="height:320px"></canvas>
    </div></div>
  </div>
</div>

<!-- =====================================================
  7ï¸âƒ£ QUICK ACTIONS
===================================================== -->
<div class="mb-5 reveal">
  <a href="{% url 'transactions:add_transaction' %}" class="btn btn-success">âž• Add</a>
  <a href="{% url 'transactions:monthly_pdf' %}" class="btn btn-outline-dark ms-2">â¬‡ PDF</a>
  <a href="{% url 'transactions:create_budget' %}" class="btn btn-outline-primary ms-2">âž• Budget</a>
   <a
  href="{% url 'transactions:expense_category_chart' %}"
  class="btn btn-outline-primary ms-2"
>
  ðŸ“Š Category Analysis
</a>
</div>

<!-- =====================================================
  8ï¸âƒ£ AI CHAT
===================================================== -->
<div class="card reveal">
  <div class="card-body">
    <h5 class="fw-bold">ðŸ¤– AI Assistant</h5>

    <div id="chatBox" style="height:260px;overflow-y:auto" class="mb-3">
      <div class="text-muted">Ask me about your budget, expenses, savingsâ€¦</div>
    </div>

    <div class="input-group">
      <input id="chatInput" class="form-control" placeholder="Ask somethingâ€¦">
      <button id="chatSend"
              class="btn btn-primary"
              style="background:linear-gradient(135deg,var(--savings-start),var(--savings-end));border:none">
        Send
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* Reveal animation */
  const obs=new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      if(entry.isIntersecting) entry.target.classList.add("active");
    });
  },{threshold:.15});
  document.querySelectorAll(".reveal").forEach(el=>obs.observe(el));

  /* Progress bars */
  document.querySelectorAll(".progress-bar").forEach(b=>{
    const percent = Number(b.dataset.percent || 0);
    let grad;
    if(percent >= 100){
      grad = `linear-gradient(90deg, var(--expense-start), var(--expense-end))`;
    } else if(percent >= 80){
      grad = `linear-gradient(90deg, var(--gold-1), var(--expense-start))`;
    } else {
      grad = `linear-gradient(90deg, var(--income-start), var(--income-end))`;
    }
    b.style.backgroundImage = grad;
    setTimeout(()=>b.style.width=(b.dataset.percent||0)+"%",300);
  });

  /* Counter animation */
  function animate(el,val){
    let c=0,step=Math.max(val/60,1);
    (function run(){
      c+=step;
      if(c<val){
        el.innerText="â‚¹"+Math.floor(c);
        requestAnimationFrame(run);
      } else {
        el.innerText="â‚¹"+val;
      }
    })();
  }

  const incomeCounter=document.getElementById("incomeCounter");
  const expenseCounter=document.getElementById("expenseCounter");
  const savingsCounter=document.getElementById("savingsCounter");

  let bar=null,pie=null,done=false;

  function createGradients(ctx,chartArea){
    const root = getComputedStyle(document.documentElement);
    const incomeStart = root.getPropertyValue('--income-start').trim() || '#00B894';
    const incomeEnd   = root.getPropertyValue('--income-end').trim()   || '#00D2FF';
    const expenseStart= root.getPropertyValue('--expense-start').trim()|| '#FF6B6B';
    const expenseEnd  = root.getPropertyValue('--expense-end').trim()  || '#FF8A65';
    const savingsStart= root.getPropertyValue('--savings-start').trim()|| '#6F4FF2';
    const savingsEnd  = root.getPropertyValue('--savings-end').trim()  || '#A78BFA';

    const gIncome = ctx.createLinearGradient(0,chartArea.bottom,0,chartArea.top);
    gIncome.addColorStop(0, incomeEnd);
    gIncome.addColorStop(1, incomeStart);

    const gExpense = ctx.createLinearGradient(0,chartArea.bottom,0,chartArea.top);
    gExpense.addColorStop(0, expenseEnd);
    gExpense.addColorStop(1, expenseStart);

    const gSavings = ctx.createLinearGradient(0,chartArea.bottom,0,chartArea.top);
    gSavings.addColorStop(0, savingsEnd);
    gSavings.addColorStop(1, savingsStart);

    return [gIncome,gExpense,gSavings];
  }

  function load(){
    fetch("{% url 'transactions:chart_data' %}")
    .then(r=>r.json())
    .then(d=>{
      if(!done){
        animate(incomeCounter,d.income);
        animate(expenseCounter,d.expense);
        animate(savingsCounter,d.savings);
        done=true;
      }

      const barCanvas = document.getElementById('barChart');
      const pieCanvas = document.getElementById('pieChart');

      if(!bar){
        const barCtx = barCanvas.getContext('2d');

        bar = new Chart(barCtx,{
          type:"bar",
          data:{labels:["Income","Expense","Savings"],
            datasets:[{data:[d.income,d.expense,d.savings],
            backgroundColor:['#00B894','#FF6B6B','#6F4FF2'],
            borderRadius:12}]},
          options:{
            plugins:{legend:{display:false}},
            animation:{duration:900,easing:"easeOutQuart"},
            responsive:true,
            maintainAspectRatio:false,
            scales:{
              x:{grid:{display:false},ticks:{color:'#374151'}},
              y:{grid:{color:'rgba(0,0,0,.06)'},ticks:{color:'#374151'}}
            }
          },
          plugins:[{
            id: 'applyGradients',
            beforeDatasetsDraw(chart){
              const ctx = chart.ctx;
              const chartArea = chart.chartArea;
              if(!chartArea) return;
              const grads = createGradients(ctx,chartArea);
              chart.data.datasets[0].backgroundColor = grads;
            }
          }]
        });

        const pieCtx = pieCanvas.getContext('2d');
        const root = getComputedStyle(document.documentElement);
        const pIncome = root.getPropertyValue('--income-start').trim() || '#00B894';
        const pExpense = root.getPropertyValue('--expense-start').trim() || '#FF6B6B';
        const pSavings = root.getPropertyValue('--savings-start').trim() || '#6F4FF2';

        pie = new Chart(pieCtx,{
          type:"pie",
          data:{labels:["Income","Expense","Savings"],
          datasets:[{data:[d.income,d.expense,d.savings],
          backgroundColor:[pIncome,pExpense,pSavings],
          hoverOffset:10,
          borderColor:'rgba(255,255,255,0.06)',
          borderWidth:2}]},
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{usePointStyle:true}}}
          }
        });

      } else {
        bar.data.datasets[0].data=[d.income,d.expense,d.savings];
        pie.data.datasets[0].data=[d.income,d.expense,d.savings];
        bar.update();
        pie.update();
      }
    })
    .catch(err=>{
      console.error("Chart load failed",err);
    });
  }

  load(); setInterval(load,15000);

  /* Chat */
  const chatBox=document.getElementById("chatBox");
  const chatInput=document.getElementById("chatInput");
  const chatSend=document.getElementById("chatSend");

  function append(text,cls){
    const d=document.createElement("div");
    d.className=cls;
    d.innerText=text;
    chatBox.appendChild(d);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  function send(){
    const msg=chatInput.value.trim();
    if(!msg) return;
    append(msg,"chat-user");
    chatInput.value="";
    chatSend.disabled=true;
    append("typingâ€¦","chat-bot typing");

    fetch("{% url 'transactions:chat_api' %}",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-CSRFToken":"{{ csrf_token }}"
      },
      body:JSON.stringify({message:msg})
    })
    .then(r=>r.json())
    .then(d=>{
      // replace typing indicator with actual reply
      const last = Array.from(chatBox.children).reverse().find(n=>n.className.includes('chat-bot'));
      if(last) last.className = "chat-bot";
      if(last) last.innerText = d.reply || "âš ï¸ No reply";
    })
    .catch(()=>{
      const last = Array.from(chatBox.children).reverse().find(n=>n.className.includes('chat-bot'));
      if(last) last.className = "chat-bot";
      if(last) last.innerText = "âš ï¸ Chat failed";
    })
    .finally(()=>chatSend.disabled=false);
  }

  chatSend.onclick=send;
  chatInput.addEventListener("keydown",e=>e.key==="Enter"&&send());
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {

  const meter = document.querySelector(".health-meter");
  if(!meter) return;

  const score = parseInt(meter.dataset.score || 0);
  const circle = meter.querySelector(".meter-progress");
  const valueEl = document.getElementById("healthValue");

  const circumference = 327; // 2 * PI * r
  const offset = circumference - (score / 100) * circumference;

  // Animate arc
  setTimeout(() => {
    circle.style.strokeDashoffset = offset;
  }, 300);

  // Animate number
  let current = 0;
  const step = Math.max(score / 60, 1);

  (function count(){
    current += step;
    if(current < score){
      valueEl.innerText = Math.floor(current);
      requestAnimationFrame(count);
    } else {
      valueEl.innerText = score;
    }
  })();

});
</script>

<script>
document.addEventListener("DOMContentLoaded",()=>{

  document.querySelectorAll(".health-breakdown .progress-bar")
    .forEach(bar=>{
      setTimeout(()=>{
        bar.style.width = (bar.dataset.percent || 0) + "%";
      },300);
    });

});
</script>



{% endblock %}
